from fabric.api import *
from fabric.contrib.console import *
from fabric.contrib.files import *
from fabric.colors import *



@roles('stagingserver')
def run_buildout():
    env.user = '${config:app_user}'
    username = '${config:app_user}'
    projectname = '${config:projectname}'
    git_url = '${config:git-url}'

    with cd('/home/{user}/sites/{project}'.format(user=username, project=projectname)):
        run('git clone {git_url} buildout'.format(git_url=git_url))
#        run('source bin/activate')

@roles('stagingserver')
def build_staging():
    env.user = '${config:app_user}'
    username = '${config:app_user}'
    projectname = '${config:projectname}'

    with cd('/home/{user}/sites/{project}/buildout'.format(user=username, project=projectname)):
        run('source ../bin/activate')
        run('touch buildout.cfg')
        run('echo "[buildout]" >> buildout.cfg')
        run('echo "extends = config/staging.cfg" >> buildout.cfg')
        run('python bootstrap.py')
        run('./bin/buildout -vvv')

@roles('stagingserver')
def start_staging():
    env.user = '${config:app_user}'
    username = '${config:app_user}'
    projectname = '${config:projectname}'

    with cd('/home/{user}/sites/{project}/buildout'.format(user=username, project=projectname)
       run('./bin/supervisord')


@roles('stagingserver')
def stop_staging():
    env.user = '${config:app_user}'
    projectname = '${config:projectname}'

    with cd('/home/{user}/sites/{project}/buildout'.format(user=username, project=projectname))
        run('./bin/supervisorctl shutdown all')

@roles('stagingserver')
def update_staging():
    env.user = '${config:app_user}'
    projectname = '${config:projectname}'

    with cd('/home/{user}/sites/{project}/buildout'.format(user=username, project=projectname))
        run('nice git pull --rebase')
        run('./bin/buildout -Nvvv')
